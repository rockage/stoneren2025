<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸–å­è¯¦æƒ… - STONEREN-BBS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-100 p-4">

    <div x-data="CommentData()" x-init="alpineInit()" class="w-full max-w-screen-md mx-auto space-y-6">
        <!-- è¿”å›æŒ‰é’® -->
        <button @click="goBack()" class="text-blue-600 hover:underline">â¬… è¿”å›</button>

        <!-- **ä¸»é¢˜å¸–å­** -->
        <div class="w-full bg-white p-6 shadow-md rounded-lg">
            <template x-if="loadingComments">
                <p class="text-gray-500 text-center">åŠ è½½ä¸­...</p>
            </template>

            <template x-if="error">
                <p class="text-red-500 text-center" x-text="error"></p>
            </template>

            <template x-if="firstComment">
                <div>
                    <div class="flex items-center space-x-3">
                        <img src="public/avatar.png" alt="ç”¨æˆ·å¤´åƒ" class="w-16 h-16 rounded-full">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-700 text-lg" x-text="firstComment.author"></span>
                            <span class="text-sm text-gray-500" x-text="firstComment.dateline"></span>
                        </div>
                    </div>

                    <h2 class="mt-3 text-xl font-bold text-gray-800 text-left" x-text="firstComment.subject"></h2>
                    <p class="mt-2 text-[#85878e] text-md text-left leading-relaxed whitespace-pre-line"
                        x-text="firstComment.message"></p>

                    <div class="mt-4 flex justify-between text-gray-500 text-sm">
                        <span>ğŸ‘€ æµè§ˆï¼ˆ<span x-text="firstComment.views"></span>ï¼‰</span>
                        <span>ğŸ‘ ç‚¹èµï¼ˆ<span x-text="firstComment.likes"></span>ï¼‰</span>
                        <span>â­ æ”¶è—</span>
                    </div>
                </div>
            </template>
        </div>

        <!-- **è¯„è®ºåŒº** -->
        <div class="w-full bg-white p-6 shadow-md rounded-lg">
            <h3 class="text-lg font-bold text-gray-800 border-b pb-2">å…¨éƒ¨è¯„è®º</h3>

            <!-- ç™»å½•æç¤º -->
            <p class="text-gray-500 text-sm mt-2">è¯· <span class="text-blue-600 cursor-pointer">ç™»å½•</span> åå‘è¡¨è¯„è®º</p>

            <template x-for="comment in otherComments" :key="comment.pid">
                <div class="border-b py-3 flex justify-between items-start">
                    <!-- å·¦ä¾§ï¼šå¤´åƒ + ç”¨æˆ·å + å†…å®¹ -->
                    <div class="flex space-x-3">
                        <img src="public/avatar.png" alt="ç”¨æˆ·å¤´åƒ" class="w-10 h-10 rounded-full">
                        <div class="flex-1">
                            <p class="font-bold text-gray-700 text-sm" x-text="comment.author"></p>
                            <p class="text-[#85878e] text-sm text-left leading-relaxed whitespace-pre-line"
                                x-text="comment.message"></p>
                            <div class="flex items-center text-gray-400 text-xs space-x-4 mt-1">
                                <span x-text="comment.dateline"></span>
                                <span>ğŸ‘ ç‚¹èµ</span>
                                <span>ğŸ’¬ è¯„è®º</span>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šæ¥¼å±‚è®¡æ•°å™¨ -->
                    <span class="  px-2 py-1 rounded text-sm text-[#DCDCDC]">
                        #<span x-text="comment.position"></span>
                    </span>
                </div>
            </template>

            <!-- åŠ è½½æ›´å¤šè¯„è®º -->
            <div x-ref="loadMoreTrigger" class="text-center text-gray-500 p-4">
                <template x-if="loadingComments">
                    <p>åŠ è½½ä¸­...</p>
                </template>
                <template x-if="allCommentsLoaded">
                    <p>æ²¡æœ‰æ›´å¤šè¯„è®ºäº†</p>
                </template>
            </div>
        </div>
    </div>

    <script>
        function CommentData() {
            return {

                comments: [],
                firstComment: null,
                otherComments: [],
                tid: new URLSearchParams(window.location.search).get('tid'),
                error: '',
                page: 1,
                loadingComments: false,
                allCommentsLoaded: false,
                tid: 2,

                fetchComments() {
                    if (this.loadingComments || this.allCommentsLoaded) return;
                    this.loadingComments = true;

                    axios.get(`http://192.168.12.113:5050/comments?tid=${this.tid}&page=${this.page}`)
                        .then(response => {
                            if (response.data.length > 0) {
                                this.comments.push(...response.data);
                                this.page++;
                                this.splitComments()
                            } else {
                                this.allCommentsLoaded = true;
                            }
                        })
                        .catch(error => {
                            console.error("Axios Error:", error);
                        })
                        .finally(() => {
                            this.loadingComments = false;
                        });
                },
                splitComments() {
                    if (this.comments.length > 0) {
                        this.firstComment = this.comments.find(function (c) {
                            return c.position == 1
                        })

                        this.otherComments = this.comments.filter(function (c) {
                            return c.position > 1
                        })
                    }

                },

                setupObserver() {
                    let observer = new IntersectionObserver((entries) => {
                        if (entries[0].isIntersecting) {
                            this.fetchComments();
                        }
                    }, { rootMargin: "100px" });

                    observer.observe(this.$refs.loadMoreTrigger);
                },

                alpineInit() {
                    this.fetchComments(); // å…ˆåŠ è½½ç¬¬ä¸€é¡µ
                    this.setupObserver(); // å¯åŠ¨ IntersectionObserver ç›‘å¬æ‡’åŠ è½½
                },

                goBack() {
                    window.history.back();
                }
            };
        }
    </script>

</body>

</html>