<div x-data="CommentData()" x-init="alpineInit()" class="w-full max-w-screen-md mx-auto space-y-6">
    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <div x-data="{ showTop: false }" x-init="window.addEventListener('scroll', () => { showTop = window.scrollY > 300})"
        class="fixed bottom-6 right-6 z-50">
        <button x-show="showTop" x-transition @click="window.scrollTo({ top: 0, behavior: 'smooth' })"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow-lg text-sm">
            â¬† å›åˆ°é¡¶éƒ¨
        </button>
    </div>
    <!-- è¿”å›æŒ‰é’® -->
    <button @click="goBackToThread" class="text-blue-600 hover:underline">â¬… è¿”å›</button>

    <!-- **ä¸»é¢˜å¸–å­** -->
    <div class="w-full bg-white p-6 shadow-md rounded-lg">
        <template x-if="loadingComments">
            <p class="text-gray-500 text-center">åŠ è½½ä¸­...</p>
        </template>

        <template x-if="error">
            <p class="text-red-500 text-center" x-text="error"></p>
        </template>

        <template x-if="firstComment">
            <div>
                <div class="flex items-center space-x-3">
                    <img src="public/avatar.png" alt="ç”¨æˆ·å¤´åƒ" class="w-16 h-16 rounded-full">
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-700 text-lg cursor-pointer" x-text="firstComment.author"
                            @click="openDetail(firstComment.authorid)"></span>
                        <span class="text-sm text-gray-500" x-text="firstComment.dateline"></span>
                    </div>
                </div>

                <h2 class="mt-3 text-xl font-bold text-gray-800 text-left" x-text="firstComment.subject"></h2>
                <p class="mt-2 text-[#85878e] text-md text-left leading-relaxed whitespace-pre-line"
                    x-text="firstComment.message"></p>

                <div class="mt-4 flex justify-between text-gray-500 text-sm">
                    <span>ğŸ‘€ æµè§ˆï¼ˆ<span x-text="firstComment.views"></span>ï¼‰</span>
                    <span>ğŸ‘ ç‚¹èµï¼ˆ<span x-text="firstComment.likes"></span>ï¼‰</span>
                    <span>â­ æ”¶è—</span>
                </div>
            </div>
        </template>
    </div>
    <!-- **è¯„è®ºåŒº** -->
    <div class="w-full bg-white p-6 shadow-md rounded-lg">
        <h3 class="text-lg font-bold text-gray-800 border-b pb-2">å…¨éƒ¨è¯„è®º</h3>

        <!-- ç™»å½•æç¤º -->
        <p class="text-gray-500 text-sm mt-2">è¯· <span class="text-blue-600 cursor-pointer">ç™»å½•</span> åå‘è¡¨è¯„è®º</p>

        <template x-for="comment in otherComments" :key="comment.pid">
            <div class="border-b py-3 flex justify-between items-start">
                <!-- å·¦ä¾§ï¼šå¤´åƒ + ç”¨æˆ·å + å†…å®¹ -->
                <div class="flex space-x-3">
                    <img src="public/avatar.png" alt="ç”¨æˆ·å¤´åƒ" class="w-10 h-10 rounded-full">
                    <div class="flex-1">
                        <p class="font-bold text-gray-700 text-sm cursor-pointer" x-text="comment.author"
                            @click="openDetail(comment.authorid)"></p>
                        <p class="text-[#85878e] text-sm text-left leading-relaxed whitespace-pre-line"
                            x-text="comment.message"></p>
                        <div class="flex items-center text-gray-400 text-xs space-x-4 mt-1">
                            <span x-text="comment.dateline"></span>
                            <span>ğŸ‘ ç‚¹èµ</span>
                            <span>ğŸ’¬ è¯„è®º</span>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šæ¥¼å±‚è®¡æ•°å™¨ -->
                <span class="  px-2 py-1 rounded text-sm text-[#DCDCDC]">
                    #<span x-text="comment.position"></span>
                </span>
            </div>
        </template>

        <!-- åŠ è½½æ›´å¤šè¯„è®º -->
        <div x-ref="loadMoreTrigger" class="text-center text-gray-500 p-4">
            <template x-if="loadingComments">
                <p>åŠ è½½ä¸­...</p>
            </template>
            <template x-if="allCommentsLoaded">
                <p>æ²¡æœ‰æ›´å¤šè¯„è®ºäº†</p>
            </template>
        </div>
    </div>
</div>

<script>




    function CommentData() {
        return {

            comments: [],
            firstComment: null,
            otherComments: [],
            tid: Alpine.store("post").tid,
            error: '',
            page: 1,
            loadingComments: false,
            allCommentsLoaded: false,

            // æ‰“å¼€å…¨å±€å¼¹çª—ï¼šç”¨æˆ·è¯¦æƒ…
            openDetail(uid) {
                Alpine.store("global").uid = uid
                Alpine.store("global").getUserProfile()
            },
            fetchComments() {
                if (this.loadingComments || this.allCommentsLoaded) return;
                this.loadingComments = true;

                axios.get(`http://192.168.12.113:5050/comments?tid=${this.tid}&page=${this.page}`)
                    .then(response => {
                        if (response.data && Array.isArray(response.data)) {
                            if (response.data.length > 0) {
                                this.comments.push(...response.data)
                                this.page++
                                this.splitComments()
                                if (response.data.length < 10) {
                                    this.allCommentsLoaded = true
                                }
                            } else {
                                this.allCommentsLoaded = true
                            }
                        } else {
                            this.allCommentsLoaded = true
                            console.error("API è¿”å›çš„æ•°æ®ä¸æ˜¯æ•°ç»„:", response.data)
                        }
                    })
                    .catch(error => {
                        console.error("Axios Error:", error);
                    })
                    .finally(() => {
                        this.loadingComments = false;
                    });
            },
            splitComments() {
                if (this.comments.length > 0) {
                    this.firstComment = this.comments.find(function (c) {
                        return c.position == 1
                    })

                    this.otherComments = this.comments.filter(function (c) {
                        return c.position > 1
                    })
                }

            },

            setupObserver() {
                let observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting) {
                        this.fetchComments();
                    }
                }, { rootMargin: "100px" });

                observer.observe(this.$refs.loadMoreTrigger);
            },


            alpineInit() {

                history.pushState(null, null, window.location.href);
                window.addEventListener('popstate', function (e) {
                    e.preventDefault();
                    window.dispatchEvent(new Event("backThread"))
                    history.pushState(null, null, window.location.href);
                });

                // ç§»åŠ¨ç«¯æ‰‹åŠ¿æ£€æµ‹ï¼ˆå³æ»‘è¿”å›ï¼‰
                let startX = 0;
                document.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, { passive: false });

                document.addEventListener('touchmove', (e) => {
                    if (startX < 10 && e.touches[0].clientX > startX + 50) {
                        e.preventDefault();
                        console.log("back");
                    }
                }, { passive: false });



                this.setupObserver(); // å¯åŠ¨ IntersectionObserver ç›‘å¬æ‡’åŠ è½½
                this.fetchComments(); // å…ˆåŠ è½½ç¬¬ä¸€é¡µ
                requestAnimationFrame(() => { //å‘Šè¯‰æµè§ˆå™¨ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ã€‚å®ƒè¦æ±‚æµè§ˆå™¨åœ¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰ï¼Œè°ƒç”¨ç”¨æˆ·æä¾›çš„å›è°ƒå‡½æ•°ã€‚

                    window.scrollTo(0, 0) // æ»šåŠ¨æ¡æ‹‰åˆ°æœ€å‰

                });
            },

            goBackToThread() {
                window.dispatchEvent(new Event("backThread"))
            },
        };
    }
</script>